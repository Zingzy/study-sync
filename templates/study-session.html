{% extends 'base.html' %}

{% block title %}Session Detail{% endblock %}

{% block content %}

<h1>Session Detail</h1>
<p>Session ID: {{ session_data.session_id }}</p>
<p>Session Name: {{ session_data.session_name }}</p>
<p>Session Type: {{ session_data.session_type }}</p>

<h2>Participants</h2>
<ol>
    {% for participant in session_data.participants %}
    <li>{{ participant }}</li>
    {% endfor %}
</ol>

<h2>Live Chat</h2>

<div id="chat-box">
    {% for message in session_data.chat_messages %}
    <p><strong>{{ message.email }}:</strong> {{ message.message }}</p>
    {% endfor %}
</div>

<form id="chat-form">
    <input type="text" id="message-input" autocomplete="off" placeholder="Type your message here..." />
    <button type="submit">Send</button>
</form>

<hr>

<h2>Resources</h2>

<div id="resources-list">
    <!-- Display resources here -->
    {% for resource in session_data.resources %}
    <p><a href="{{ resource.link }}" target="_blank">{{ resource.name }} {{ loop.index }} ({{ resource.ext }})</a> by {{
        resource.uploader }}</p>
    {% endfor %}
</div>

<form id="upload-form">
    <input type="file" id="file-input" />
    <button type="submit">Upload Resource</button>
</form>


<br><br>

<!-- If the user is not the owner of the session, add a leave session button else an end session button -->
{% if session_data.session_owner != email %}
<form id="leave-session-form" method="post" action="{{ url_for('leave_session', session_id=session_data.session_id) }}">
    <button type="submit">Leave Session</button>
</form>
{% else %}
<form id="end-session-form" method="post" action="{{ url_for('end_session', session_id=session_data.session_id) }}">
    <button type="submit">End Session</button>
</form>
{% endif %}

{% endblock %}

{% block custom_js_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script type="text/javascript">
    var socket = io.connect(window.location.origin);

    socket.emit("join", { "session_id": "{{ session_data.session_id }}" });

    socket.on("connect", function () {
        console.log("Connected to WebSocket server");
    });

    socket.on("end_session", function (data) {
        if (data.session_id === "{{ session_data.session_id }}") {
            alert("The session has ended.");
            window.location.href = "{{ url_for('home') }}";
        }
    });

    socket.on("receive_message", function (data) {
        var chatBox = document.getElementById("chat-box");
        var messageElement = document.createElement("p");
        messageElement.innerHTML = "<strong>" + data.email + ":</strong> " + data.message;
        chatBox.appendChild(messageElement);

        chatBox.scrollTop = chatBox.scrollHeight;

        // do not play the beep sound if the message is from the current user
        if (data.email === "{{ email }}") {
            return;
        }
        var beep = new Audio("{{ url_for('static', filename='beep.mp3') }}");
        beep.play();
    });

    socket.on("update_participants", function (data) {
        var participantsList = document.getElementById("participants-list");
        participantsList.innerText = data.participants.join(", ");
    });

    document.getElementById("chat-form").addEventListener("submit", function (event) {
        event.preventDefault();
        var messageInput = document.getElementById("message-input");
        var message = messageInput.value;
        socket.emit("send_message", { "session_id": "{{ session_data.session_id }}", "message": message });
        messageInput.value = "";
    });

    try {
        document.getElementById("leave-session-form").addEventListener("submit", function (event) {
            event.preventDefault();
            socket.emit("leave", { "session_id": "{{ session_data.session_id }}" });
        });
    }
    catch (e) {
        console.log("User is the owner of the session");
    }

    document.getElementById("upload-form").addEventListener("submit", function (event) {
        event.preventDefault();

        var fileInput = document.getElementById("file-input");
        var file = fileInput.files[0];

        if (!file) {
            alert("Please select a file to upload.");
            return;
        }

        // check if the file size is greter than 15MB
        if (file.size > 15 * 1024 * 1024) {
            alert("File size should be less than 15MB.");
            return;
        }

        var formData = new FormData();
        formData.append("file", file);

        // Upload to i.spoo.me
        fetch("https://i.spoo.me/upload", {
            method: "POST",
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.url) {
                    // Send the URL to your Flask backend
                    fetch("{{ url_for('upload_resource') }}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            session_id: "{{ session_data.session_id }}",
                            link: data.url,
                            name: file.name.split('.').slice(0, -1).join('.'),
                            ext: file.name.split('.').pop()
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                socket.emit("resource_uploaded", {
                                    session_id: "{{ session_data.session_id }}",
                                    resource: data.resource
                                });
                                alert("Resource uploaded successfully!");
                            } else {
                                alert("Failed to upload resource.");
                            }
                        });
                } else {
                    alert("Failed to upload file.");
                }
            });
    });

    socket.on("update_resources", function (data) {
        var resource = data.resource;
        var resourcesList = document.getElementById("resources-list");

        var resourceElement = document.createElement("p");
        resourceElement.innerHTML = '<a href="' + resource.link + '" target="_blank">Resource (' + resource.ext + ')</a> by ' + resource.uploader;
        resourcesList.appendChild(resourceElement);
    });


</script>
{% endblock %}