{% extends 'base.html' %}

{% block title %}Welcome{% endblock %}

{% block content %}

<h1>Welcome, {{ email }}!</h1>
<a href="{{ url_for('logout') }}">Logout</a>

<!-- Form to create a new session -->
<h2>Create a New Session</h2>
<form id="create-session-form" method="post" action="{{ url_for('create_session') }}">
    <label for="session-name">Session Name:</label>
    <input type="text" id="session-name" name="session-name" required><br><br>
    <label for="session-type">Session Type:</label>
    <select id="session-type" name="session-type">
        <option value="public">Public</option>
        <option value="private">Private</option>
    </select><br><br>
    <button type="submit">Create Session</button>
</form>

<!-- Section to display sessions created by the user -->
<h2>Your Sessions</h2>
<div id="user-sessions">
    <!-- Sessions will be populated here via JavaScript -->
</div>

<h2>Joined Sessions</h2>
<div id="joined-sessions">
    <!-- Sessions will be populated here via JavaScript -->
</div>

<!-- Form to join a session by session ID and optional password -->
<h2>Join a Session</h2>
<form id="join-session-form" method="get" action="#">
    <label for="session-id">Session ID:</label>
    <input type="text" id="session-id" name="session-id" required><br><br>
    <label for="password">Password (if private):</label>
    <input type="password" id="password" name="password"><br><br>
    <button type="button" onclick="joinSession()">Join Session</button>
</form>

{% endblock %}

{% block custom_js_scripts %}

<script>
    // Function to create a session
    document.getElementById('create-session-form').addEventListener('submit', function (event) {
        event.preventDefault();
        const formData = new FormData(this);
        fetch('{{ url_for("create_session") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert('Session created successfully!');
                    loadUserSessions(); // Reload the list of user sessions
                }
            });
    });

    // Function to load user sessions
    function loadUserSessions() {
        fetch('{{ url_for("get_sessions") }}', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                const sessionsDiv = document.getElementById('user-sessions');
                sessionsDiv.innerHTML = ''; // Clear existing content
                data.forEach(session => {
                    const sessionElement = document.createElement('div');
                    sessionElement.innerHTML = `
                    <p>Session ID: ${session.session_id}</p>
                    <p>Session Name: ${session.session_name}</p>
                    <p>Session Type: ${session.session_type}</p>
                    ${session.session_type === 'private' ? `
                        <p>
                            Session Password:
                            <input type="password" id="session-password-${session.session_id}" value="${session.session_password}" readonly>
                            <button type="button" onclick="togglePasswordVisibility('session-password-${session.session_id}')">Show</button>
                        </p>
                    ` : ''}
                    <button type="button" onclick="joinSessionWithPassword('${session.session_id}', '${session.session_type}', '${session.session_password}')">Join</button>
                    <button type="button" onclick="copySessionLink('${session.session_id}', '${session.session_type}', '${session.session_password}')">Copy Link</button>
                    <button onclick="endSession('${session.session_id}')">End</button>
                    <hr>
                `;
                    sessionsDiv.appendChild(sessionElement);
                });
            });
    }

    function loadJoinedSessions() {
        fetch('{{ url_for("get_joined_sessions") }}', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                const sessionsDiv = document.getElementById('joined-sessions');
                sessionsDiv.innerHTML = ''; // Clear existing content
                data.forEach(session => {
                    const sessionElement = document.createElement('div');
                    sessionElement.innerHTML = `
                    <p>Session ID: ${session.session_id}</p>
                    <p>Session Name: ${session.session_name}</p>
                    <p>Session Type: ${session.session_type}</p>
                    ${session.session_type === 'private' ? `
                        <p>
                            Session Password:
                            <input type="password" id="session-password-${session.session_id}" value="${session.session_password}" readonly>
                            <button type="button" onclick="togglePasswordVisibility('session-password-${session.session_id}')">Show</button>
                        </p>
                    ` : ''}
                    <button type="button" onclick="joinSessionWithPassword('${session.session_id}', '${session.session_type}', '${session.session_password}')">Go Back</button>
                    <button type="button" onclick="leaveSession('${session.session_id}')">Leave</button>
                    <hr>
                `;
                    sessionsDiv.appendChild(sessionElement);
                });
            });
    }

    // Function to toggle password visibility
    function togglePasswordVisibility(inputId) {
        const passwordInput = document.getElementById(inputId);
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
        } else {
            passwordInput.type = 'password';
        }
    }

    // Function to join a session with password
    function joinSessionWithPassword(sessionId, sessionType, sessionPassword) {
        let url = `{{ url_for('join_session', session_id='') }}${sessionId}`;
        if (sessionType === 'private') {
            url += `?password=${sessionPassword}`;
        }
        window.location.href = url;
    }

    // Function to copy session link to clipboard
    function copySessionLink(sessionId, sessionType, sessionPassword) {
        let url = `{{ url_for('join_session', session_id='') }}${sessionId}`;
        if (sessionType === 'private') {
            url += `?password=${sessionPassword}`;
        }
        navigator.clipboard.writeText(url).then(() => {
            alert('Session link copied to clipboard!');
        }, () => {
            alert('Failed to copy session link to clipboard.');
        });
    }

    // Function to join a session
    function joinSession() {
        const sessionId = document.getElementById('session-id').value;
        const password = document.getElementById('password').value;
        const url = `{{ url_for('join_session', session_id='') }}${sessionId}?password=${password}`;
        window.location.href = url;
    }

    // Function to end a session
    function endSession(sessionId) {
        fetch(`{{ url_for('end_session', session_id='') }}${sessionId}`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert('Session ended successfully!');
                    loadUserSessions(); // Reload the list of user sessions
                }
            });
    }

    function leaveSession(sessionId) {
        fetch(`{{ url_for('leave_session', session_id='') }}${sessionId}`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert('Session left successfully!');
                    loadJoinedSessions(); // Reload the list of joined sessions
                }
            });
    }

    // Load user sessions on page load
    document.addEventListener('DOMContentLoaded', loadUserSessions);
    document.addEventListener('DOMContentLoaded', loadJoinedSessions);
</script>

{% endblock %}